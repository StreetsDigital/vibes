# Vibes Stack - Caddy Configuration
# ===================================
# Automatic HTTPS with Let's Encrypt
# Reverse proxy to internal services
#
# For local development, use localhost
# For production, set DOMAIN in .env

# Global options
{
	# Email for Let's Encrypt notifications
	email {$ACME_EMAIL:admin@example.com}

	# Staging for testing (uncomment to avoid rate limits)
	# acme_ca https://acme-staging-v02.api.letsencrypt.org/directory
}

# Main domain - Vibes Frontend (Kanban + Claude Chat)
{$DOMAIN:localhost} {
	# Basic auth - username: vibes
	basic_auth {
		vibes $2a$14$1n9XrsRS7elpvdW6NGOB4uBlYMBgiXLNRHhEw.QkvP6YZ2fxbj2Cy
	}

	# Project manager API
	handle /api/manager/* {
		uri strip_prefix /api/manager
		reverse_proxy project-manager:3009
	}

	# Dynamic project routing (vibes-project-{id} containers)
	handle /project/* {
		uri strip_prefix /project
		# Extract project ID and route to its container
		# Projects run on ports 3010-3019
		reverse_proxy vibes-project-*:3000 {
			lb_policy first
		}
	}

	# Frontend app (default project)
	reverse_proxy frontend:3000

	# Security headers
	header {
		X-Content-Type-Options nosniff
		X-Frame-Options DENY
		Referrer-Policy strict-origin-when-cross-origin
	}

	# Logging
	log {
		output file /data/access.log
		format json
	}
}

# Dashboard subdomain
dash.{$DOMAIN:localhost} {
	basic_auth {
		vibes $2a$14$1n9XrsRS7elpvdW6NGOB4uBlYMBgiXLNRHhEw.QkvP6YZ2fxbj2Cy
	}

	reverse_proxy dashboard:8080

	header {
		X-Content-Type-Options nosniff
		X-Frame-Options SAMEORIGIN
	}
}

# API subdomain (for future use)
api.{$DOMAIN:localhost} {
	# MCP server or other APIs
	reverse_proxy kanban:3000 {
		header_up X-Forwarded-Proto {scheme}
	}
}

# Ollama API (if enabled)
ollama.{$DOMAIN:localhost} {
	# Basic auth for Ollama access
	basic_auth {
		{$OLLAMA_USER:admin} {$OLLAMA_HASH:JDJhJDE0JDdQa3lQWnFQTnFQTnFQTnFQTnFQTnFQTnFQTnFQTnFQTnFQTnFQTnFQTnFQTnFQTnFQ}
	}

	reverse_proxy ollama:11434
}

# Health check endpoint
:8888 {
	respond /health 200
	respond /ready 200
}
