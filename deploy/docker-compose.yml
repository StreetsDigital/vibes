version: "3.8"

# Vibes Stack - Full Deployment
# ==============================
# Docker Compose for running the complete vibes stack:
# - Caddy (reverse proxy + automatic SSL)
# - Vibe-Kanban (visual task management)
# - Vibes Dashboard (activity monitoring)
# - Ollama (optional local LLM)
#
# Usage:
#   cp .env.example .env
#   # Edit .env with your domain and API keys
#   docker compose up -d

services:
  # ===========================================
  # Reverse Proxy (Caddy)
  # ===========================================
  caddy:
    image: caddy:2-alpine
    container_name: vibes-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    environment:
      - DOMAIN=${DOMAIN:-localhost}
    networks:
      - vibes-network
    depends_on:
      - frontend
      - dashboard

  # ===========================================
  # Cloudflare WARP (VPN Proxy for correct geolocation)
  # ===========================================
  warp:
    image: caomingjun/warp:latest
    container_name: vibes-warp
    restart: unless-stopped
    environment:
      - WARP_SLEEP=2
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=0
      - net.ipv4.conf.all.src_valid_mark=1
    volumes:
      - warp_data:/var/lib/cloudflare-warp
    networks:
      - vibes-network
    healthcheck:
      test: ["CMD", "curl", "-fsS", "--socks5", "localhost:1080", "https://cloudflare.com/cdn-cgi/trace"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===========================================
  # HTTP Proxy (SOCKS5 to HTTP for Node.js)
  # ===========================================
  hpts:
    image: node:20-alpine
    container_name: vibes-hpts
    restart: unless-stopped
    command: sh -c "npm install -g http-proxy-to-socks && hpts -s warp:1080 -p 8080 -l 0.0.0.0"
    networks:
      - vibes-network
    depends_on:
      warp:
        condition: service_healthy

  # ===========================================
  # Vibes Frontend (Kanban + Claude Chat)
  # ===========================================
  frontend:
    build:
      context: ..
      dockerfile: frontend/Dockerfile
    container_name: vibes-frontend
    restart: unless-stopped
    environment:
      - VIBES_USE_BEADS=true
      # Claude
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN:-}
      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      # Google
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      # GitHub (for Copilot/CLI tools)
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      # Groq
      - GROQ_API_KEY=${GROQ_API_KEY:-}
      # Route traffic through HTTP proxy (HPTS converts to SOCKS5->WARP)
      - HTTPS_PROXY=http://hpts:8080
      - HTTP_PROXY=http://hpts:8080
      - NO_PROXY=localhost,127.0.0.1,vibes-warp,vibes-frontend,vibes-dashboard,vibes-caddy,vibes-hpts
    volumes:
      - projects:/projects
      - claude_credentials:/root/.claude
    networks:
      - vibes-network
    expose:
      - "3000"
    depends_on:
      warp:
        condition: service_healthy

  # ===========================================
  # Vibe-Kanban (Alternative - if you prefer)
  # ===========================================
  # kanban:
  #   image: node:20-alpine
  #   container_name: vibes-kanban
  #   restart: unless-stopped
  #   working_dir: /app
  #   command: sh -c "npm install -g vibe-kanban && vibe-kanban serve --host 0.0.0.0 --port 3000"
  #   environment:
  #     - NODE_ENV=production
  #     - VIBES_USE_BEADS=true
  #   volumes:
  #     - projects:/projects
  #     - kanban_data:/app/.vibe-kanban
  #   networks:
  #     - vibes-network
  #   expose:
  #     - "3000"

  # ===========================================
  # Project Manager (Container Orchestration)
  # ===========================================
  project-manager:
    build:
      context: ./project-manager
      dockerfile: Dockerfile
    container_name: vibes-project-manager
    restart: unless-stopped
    environment:
      - PROJECTS_BASE=/home/vibes/projects
      - DOCKER_NETWORK=vibes-network
      - BASE_PORT=3010
      - MAX_PROJECTS=10
      - FRONTEND_IMAGE=deploy-frontend:latest
      # Pass all API keys to spawned containers
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /home/vibes/projects:/home/vibes/projects
      - manager_data:/data
    networks:
      - vibes-network
    expose:
      - "3009"

  # ===========================================
  # Vibes Dashboard (Activity Monitoring)
  # ===========================================
  dashboard:
    build:
      context: ..
      dockerfile: deploy/Dockerfile.dashboard
    container_name: vibes-dashboard
    restart: unless-stopped
    environment:
      - DASHBOARD_PORT=8080
      - ACTIVITY_LOG=/data/logs/activity.jsonl
    volumes:
      - dashboard_data:/data
      - projects:/projects:ro
    networks:
      - vibes-network
    expose:
      - "8080"

  # ===========================================
  # Ollama (Local LLM - Optional)
  # ===========================================
  ollama:
    image: ollama/ollama:latest
    container_name: vibes-ollama
    restart: unless-stopped
    profiles:
      - with-ollama
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - vibes-network
    expose:
      - "11434"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # ===========================================
  # PostgreSQL (for Kanban persistence)
  # ===========================================
  postgres:
    image: postgres:16-alpine
    container_name: vibes-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-vibes}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-vibes_secret}
      - POSTGRES_DB=${POSTGRES_DB:-vibes_kanban}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - vibes-network
    expose:
      - "5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-vibes}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================
  # Redis (for caching/sessions)
  # ===========================================
  redis:
    image: redis:7-alpine
    container_name: vibes-redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - vibes-network
    expose:
      - "6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

# ===========================================
# Networks
# ===========================================
networks:
  vibes-network:
    name: vibes-network
    driver: bridge

# ===========================================
# Volumes
# ===========================================
volumes:
  caddy_data:
  caddy_config:
  kanban_data:
  dashboard_data:
  manager_data:
  ollama_data:
  postgres_data:
  redis_data:
  warp_data:
  claude_credentials:
  projects:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${PROJECTS_DIR:-/home/vibes/projects}
