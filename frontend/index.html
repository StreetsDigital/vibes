<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vibes - Task Board</title>

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3b82f6">

    <!-- iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Vibes">
    <link rel="apple-touch-icon" href="/icon.svg">

    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .drag-over { background-color: rgba(59, 130, 246, 0.1); }
        .dragging { opacity: 0.5; }

        /* Chat content styling */
        .chat-content { word-break: break-word; }
        .chat-content pre { white-space: pre-wrap; word-wrap: break-word; }
        .chat-content code { font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace; }

        /* Mobile kanban scroll */
        .kanban-scroll {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .kanban-scroll::-webkit-scrollbar { display: none; }

        /* Safe area for notched phones */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        }

        /* Active tab indicator */
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }

        /* Pulse animation for loading */
        @keyframes pulse-dot {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        .loading-dot { animation: pulse-dot 1.4s ease-in-out infinite; }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 px-4 py-3 flex-shrink-0">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <h1 class="text-lg font-bold text-blue-400">⚡</h1>
                <!-- Project Dropdown -->
                <div class="relative">
                    <button onclick="toggleProjectDropdown()" id="project-btn" class="flex items-center gap-1 px-2 py-1 bg-gray-700 rounded-lg hover:bg-gray-600 text-sm">
                        <span id="current-project">vibes</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div id="project-dropdown" class="hidden absolute left-0 mt-1 w-48 bg-gray-800 border border-gray-700 rounded-lg shadow-lg z-50">
                        <div id="project-list" class="py-1 max-h-60 overflow-y-auto">
                            <!-- Projects populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span id="stats" class="text-xs text-gray-400 hidden sm:inline">Loading...</span>
                <button onclick="refreshBoard()" class="p-2 bg-gray-700 rounded-lg hover:bg-gray-600 active:bg-gray-500 text-sm">
                    ↻
                </button>
            </div>
        </div>
    </header>

    <!-- Mobile Tab Bar -->
    <div class="md:hidden flex border-b border-gray-700 bg-gray-800 flex-shrink-0">
        <button id="tab-board" onclick="showView('board')" class="flex-1 py-3 text-sm font-medium text-center tab-active">
            Board
        </button>
        <button id="tab-chat" onclick="showView('chat')" class="flex-1 py-3 text-sm font-medium text-center text-gray-400">
            Claude
        </button>
        <button id="tab-tools" onclick="showView('tools')" class="flex-1 py-3 text-sm font-medium text-center text-gray-400">
            Tools
        </button>
    </div>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Kanban Board -->
        <main id="view-board" class="flex-1 flex flex-col overflow-hidden">
            <!-- Kanban Columns - horizontal scroll on mobile -->
            <div class="flex-1 overflow-x-auto overflow-y-auto kanban-scroll p-4">
                <div class="flex md:grid md:grid-cols-4 gap-3 min-w-max md:min-w-0">
                    <!-- To Do -->
                    <div class="w-72 md:w-auto bg-gray-800 rounded-lg p-3 flex-shrink-0">
                        <h2 class="font-semibold text-gray-300 mb-3 flex items-center gap-2 text-sm">
                            <span class="w-2.5 h-2.5 bg-gray-500 rounded-full"></span>
                            To Do
                            <span id="todo-count" class="text-xs bg-gray-700 px-2 py-0.5 rounded-full">0</span>
                        </h2>
                        <div id="todo" class="space-y-2 min-h-[150px]" ondragover="allowDrop(event)" ondrop="drop(event, 'pending')">
                        </div>
                    </div>

                    <!-- In Progress -->
                    <div class="w-72 md:w-auto bg-gray-800 rounded-lg p-3 flex-shrink-0">
                        <h2 class="font-semibold text-gray-300 mb-3 flex items-center gap-2 text-sm">
                            <span class="w-2.5 h-2.5 bg-blue-500 rounded-full"></span>
                            In Progress
                            <span id="progress-count" class="text-xs bg-gray-700 px-2 py-0.5 rounded-full">0</span>
                        </h2>
                        <div id="in_progress" class="space-y-2 min-h-[150px]" ondragover="allowDrop(event)" ondrop="drop(event, 'in_progress')">
                        </div>
                    </div>

                    <!-- Review -->
                    <div class="w-72 md:w-auto bg-gray-800 rounded-lg p-3 flex-shrink-0">
                        <h2 class="font-semibold text-gray-300 mb-3 flex items-center gap-2 text-sm">
                            <span class="w-2.5 h-2.5 bg-yellow-500 rounded-full"></span>
                            Review
                            <span id="review-count" class="text-xs bg-gray-700 px-2 py-0.5 rounded-full">0</span>
                        </h2>
                        <div id="needs_review" class="space-y-2 min-h-[150px]" ondragover="allowDrop(event)" ondrop="drop(event, 'needs_review')">
                        </div>
                    </div>

                    <!-- Done -->
                    <div class="w-72 md:w-auto bg-gray-800 rounded-lg p-3 flex-shrink-0">
                        <h2 class="font-semibold text-gray-300 mb-3 flex items-center gap-2 text-sm">
                            <span class="w-2.5 h-2.5 bg-green-500 rounded-full"></span>
                            Done
                            <span id="done-count" class="text-xs bg-gray-700 px-2 py-0.5 rounded-full">0</span>
                        </h2>
                        <div id="passing" class="space-y-2 min-h-[150px]" ondragover="allowDrop(event)" ondrop="drop(event, 'passing')">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Task Button -->
            <div class="p-4 border-t border-gray-700 flex-shrink-0 safe-bottom">
                <button onclick="showAddTask()" class="w-full md:w-auto px-4 py-3 bg-blue-600 rounded-lg hover:bg-blue-500 active:bg-blue-700 text-sm font-medium">
                    + Add Task
                </button>
            </div>
        </main>

        <!-- Claude Chat Sidebar -->
        <aside id="view-chat" class="hidden md:flex w-full md:w-96 bg-gray-900 md:bg-gray-800 md:border-l border-gray-700 flex-col h-full">
            <!-- Chat Header - Claude Code style -->
            <div class="bg-gray-800 rounded-xl mx-3 mt-3 p-3 flex items-center justify-between flex-shrink-0">
                <div class="flex-1 min-w-0">
                    <p id="branch-name" class="text-sm text-gray-300 truncate">main</p>
                </div>
                <button onclick="quickPrompt('Create a PR for current changes')" class="ml-2 px-3 py-1 text-sm font-medium hover:bg-gray-700 rounded">
                    View PR
                </button>
                <button onclick="showActionMenu()" class="ml-1 p-1.5 hover:bg-gray-700 rounded">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
                    </svg>
                </button>
            </div>

            <!-- Chat Messages -->
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3">
                <div class="text-gray-500 text-sm text-center py-8">
                    Start a conversation with Claude
                </div>
            </div>

            <!-- Chat Input - Claude Code style -->
            <div class="p-3 flex-shrink-0 safe-bottom">
                <div class="bg-gray-800 rounded-xl p-3">
                    <form id="chat-form" onsubmit="sendMessage(event)">
                        <textarea
                            id="chat-input"
                            placeholder="Add feedback..."
                            rows="1"
                            class="w-full bg-transparent text-base focus:outline-none resize-none overflow-hidden"
                            style="min-height: 24px; max-height: 120px;"
                            onkeydown="handleChatKeydown(event)"
                            oninput="autoResizeTextarea(this)"
                        ></textarea>
                    </form>

                    <!-- Bottom toolbar -->
                    <div class="flex items-center justify-between mt-3 pt-3 border-t border-gray-700">
                        <div class="flex items-center gap-1">
                            <span id="repo-badge" class="text-xs bg-gray-700 px-2 py-1 rounded-full text-gray-400">
                                StreetsDigital/vibes
                            </span>
                        </div>
                        <div class="flex items-center gap-1">
                            <!-- Add task -->
                            <button onclick="showAddTask()" class="p-2 hover:bg-gray-700 rounded-lg active:bg-gray-600" title="Add task">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                </svg>
                            </button>
                            <!-- Commit -->
                            <button onclick="quickPrompt('/commit')" class="p-2 hover:bg-gray-700 rounded-lg active:bg-gray-600" title="Commit">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                </svg>
                            </button>
                            <!-- PR -->
                            <button onclick="quickPrompt('Create a pull request')" class="p-2 hover:bg-gray-700 rounded-lg active:bg-gray-600" title="Create PR">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                                </svg>
                            </button>
                            <!-- Send / Stop -->
                            <button id="send-btn" onclick="submitOrStop()" class="p-2 bg-white text-gray-900 rounded-lg hover:bg-gray-200 active:bg-gray-300 ml-1" title="Send">
                                <svg id="send-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"/>
                                </svg>
                                <svg id="stop-icon" class="w-5 h-5 hidden" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Tools Panel -->
        <aside id="view-tools" class="hidden w-full md:w-96 bg-gray-900 md:bg-gray-800 md:border-l border-gray-700 flex-col h-full overflow-y-auto">
            <div class="p-4 border-b border-gray-700 flex-shrink-0">
                <h2 class="font-semibold text-gray-300">Claude Tools</h2>
                <p class="text-xs text-gray-500">MCP servers, skills, and settings</p>
            </div>

            <!-- MCP Servers Section -->
            <div class="p-4 border-b border-gray-700">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-medium text-gray-400">MCP Servers</h3>
                    <button onclick="showAddMcpModal()" class="text-xs px-2 py-1 bg-gray-700 rounded hover:bg-gray-600">+ Add</button>
                </div>
                <div id="mcp-servers-list" class="space-y-2">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Skills Section -->
            <div class="p-4 border-b border-gray-700">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-medium text-gray-400">Skills</h3>
                    <button onclick="showAddSkillModal()" class="text-xs px-2 py-1 bg-gray-700 rounded hover:bg-gray-600">+ Add</button>
                </div>
                <div id="skills-list" class="space-y-2">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="p-4">
                <h3 class="text-sm font-medium text-gray-400 mb-3">Quick Actions</h3>
                <div class="space-y-2">
                    <button onclick="quickPrompt('/commit')" class="w-full text-left px-3 py-2 bg-gray-800 rounded-lg hover:bg-gray-700 text-sm">
                        Commit changes
                    </button>
                    <button onclick="quickPrompt('Create a pull request')" class="w-full text-left px-3 py-2 bg-gray-800 rounded-lg hover:bg-gray-700 text-sm">
                        Create PR
                    </button>
                    <button onclick="quickPrompt('/verify')" class="w-full text-left px-3 py-2 bg-gray-800 rounded-lg hover:bg-gray-700 text-sm">
                        Run quality checks
                    </button>
                    <button onclick="quickPrompt('/retrospective')" class="w-full text-left px-3 py-2 bg-gray-800 rounded-lg hover:bg-gray-700 text-sm">
                        Extract learnings
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Add MCP Server Modal -->
    <div id="add-mcp-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl p-5 w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">Add MCP Server</h3>
            <form onsubmit="addMcpServer(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Name</label>
                        <input type="text" id="mcp-name" required placeholder="my-server" class="w-full bg-gray-700 rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Command</label>
                        <input type="text" id="mcp-command" required placeholder="npx" class="w-full bg-gray-700 rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Arguments (space separated)</label>
                        <input type="text" id="mcp-args" placeholder="-y @modelcontextprotocol/server-github" class="w-full bg-gray-700 rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Scope</label>
                        <select id="mcp-scope" class="w-full bg-gray-700 rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="project">Project</option>
                            <option value="global">Global</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-2 mt-6">
                    <button type="button" onclick="hideAddMcpModal()" class="flex-1 px-4 py-3 bg-gray-700 rounded-lg hover:bg-gray-600">Cancel</button>
                    <button type="submit" class="flex-1 px-4 py-3 bg-blue-600 rounded-lg hover:bg-blue-500">Add</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Skill Modal -->
    <div id="add-skill-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl p-5 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4">Create Skill</h3>
            <form onsubmit="addSkill(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Name</label>
                        <input type="text" id="skill-name" required placeholder="fix-common-error" class="w-full bg-gray-700 rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Description</label>
                        <input type="text" id="skill-description" placeholder="What this skill does" class="w-full bg-gray-700 rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Trigger (when to use)</label>
                        <textarea id="skill-trigger" rows="2" placeholder="When error X occurs..." class="w-full bg-gray-700 rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Solution</label>
                        <textarea id="skill-solution" rows="4" placeholder="Steps to fix..." class="w-full bg-gray-700 rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Scope</label>
                        <select id="skill-scope" class="w-full bg-gray-700 rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="project">Project</option>
                            <option value="global">Global</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-2 mt-6">
                    <button type="button" onclick="hideAddSkillModal()" class="flex-1 px-4 py-3 bg-gray-700 rounded-lg hover:bg-gray-600">Cancel</button>
                    <button type="submit" class="flex-1 px-4 py-3 bg-blue-600 rounded-lg hover:bg-blue-500">Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Action Menu Modal -->
    <div id="action-menu" class="fixed inset-0 bg-black/50 hidden items-end justify-center z-50" onclick="hideActionMenu()">
        <div class="bg-gray-800 rounded-t-2xl w-full max-w-lg p-4 safe-bottom" onclick="event.stopPropagation()">
            <div class="w-12 h-1 bg-gray-600 rounded-full mx-auto mb-4"></div>
            <div class="space-y-1">
                <button onclick="quickPrompt('Summarize current tasks'); hideActionMenu()" class="w-full text-left px-4 py-3 hover:bg-gray-700 rounded-lg active:bg-gray-600">
                    Summarize tasks
                </button>
                <button onclick="quickPrompt('What should I work on next?'); hideActionMenu()" class="w-full text-left px-4 py-3 hover:bg-gray-700 rounded-lg active:bg-gray-600">
                    Suggest next task
                </button>
                <button onclick="quickPrompt('/verify'); hideActionMenu()" class="w-full text-left px-4 py-3 hover:bg-gray-700 rounded-lg active:bg-gray-600">
                    Run quality checks
                </button>
                <button onclick="quickPrompt('Show git status'); hideActionMenu()" class="w-full text-left px-4 py-3 hover:bg-gray-700 rounded-lg active:bg-gray-600">
                    Git status
                </button>
                <button onclick="clearChat(); hideActionMenu()" class="w-full text-left px-4 py-3 hover:bg-gray-700 rounded-lg active:bg-gray-600 text-red-400">
                    Clear chat history
                </button>
                <button onclick="hideActionMenu()" class="w-full text-left px-4 py-3 text-gray-400 hover:bg-gray-700 rounded-lg">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div id="add-task-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl p-5 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-semibold mb-4">Add New Task</h3>
            <form onsubmit="addTask(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Name</label>
                        <input type="text" id="task-name" required class="w-full bg-gray-700 rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Description</label>
                        <textarea id="task-desc" rows="3" class="w-full bg-gray-700 rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">Test Cases (one per line)</label>
                        <textarea id="task-tests" rows="3" placeholder="Test case 1&#10;Test case 2" class="w-full bg-gray-700 rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
                <div class="flex gap-2 mt-6">
                    <button type="button" onclick="hideAddTask()" class="flex-1 px-4 py-3 bg-gray-700 rounded-lg hover:bg-gray-600 active:bg-gray-500">Cancel</button>
                    <button type="submit" class="flex-1 px-4 py-3 bg-blue-600 rounded-lg hover:bg-blue-500 active:bg-blue-700">Add</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Task Detail Modal -->
    <div id="task-detail-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-xl p-5 w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-4">
                <h3 id="detail-name" class="text-lg font-semibold pr-4"></h3>
                <button onclick="hideTaskDetail()" class="text-gray-500 hover:text-gray-300 p-1 -mr-1">✕</button>
            </div>
            <div id="detail-content" class="space-y-4">
            </div>
            <div class="flex gap-2 mt-6">
                <button onclick="hideTaskDetail()" class="flex-1 px-4 py-3 bg-gray-700 rounded-lg hover:bg-gray-600 active:bg-gray-500">
                    Close
                </button>
                <button onclick="workOnTask()" class="flex-1 px-4 py-3 bg-blue-600 rounded-lg hover:bg-blue-500 active:bg-blue-700">
                    Work on this
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentTask = null;
        let currentView = 'board';
        let isLoading = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            refreshBoard();
            fetchBranchName();
            loadChatHistory();
            loadProjects();
            checkSession();
            setInterval(refreshBoard, 10000);

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#project-btn') && !e.target.closest('#project-dropdown')) {
                    document.getElementById('project-dropdown').classList.add('hidden');
                }
            });
        });

        // Fetch current branch
        async function fetchBranchName() {
            try {
                const response = await fetch(`${API_BASE}/git/branch`);
                const data = await response.json();
                if (data.branch) {
                    document.getElementById('branch-name').textContent = data.branch;
                }
            } catch (error) {
                // Keep default
            }
        }

        // Action menu
        function showActionMenu() {
            document.getElementById('action-menu').classList.remove('hidden');
            document.getElementById('action-menu').classList.add('flex');
        }

        function hideActionMenu() {
            document.getElementById('action-menu').classList.add('hidden');
            document.getElementById('action-menu').classList.remove('flex');
        }

        // View switching for mobile
        function showView(view) {
            currentView = view;
            const views = ['board', 'chat', 'tools'];
            const viewElements = {
                board: document.getElementById('view-board'),
                chat: document.getElementById('view-chat'),
                tools: document.getElementById('view-tools')
            };
            const tabElements = {
                board: document.getElementById('tab-board'),
                chat: document.getElementById('tab-chat'),
                tools: document.getElementById('tab-tools')
            };

            views.forEach(v => {
                const viewEl = viewElements[v];
                const tabEl = tabElements[v];

                if (v === view) {
                    viewEl?.classList.remove('hidden');
                    viewEl?.classList.add('flex');
                    tabEl?.classList.add('tab-active', 'text-blue-400');
                    tabEl?.classList.remove('text-gray-400');
                } else {
                    viewEl?.classList.add('hidden');
                    viewEl?.classList.remove('flex');
                    tabEl?.classList.remove('tab-active', 'text-blue-400');
                    tabEl?.classList.add('text-gray-400');
                }
            });

            // Load tools data when switching to tools view
            if (view === 'tools') {
                loadMcpServers();
                loadSkills();
            }
        }

        // Fetch and render board
        async function refreshBoard() {
            try {
                const response = await fetch(`${API_BASE}/board`);
                const data = await response.json();
                renderBoard(data);
            } catch (error) {
                console.error('Failed to fetch board:', error);
            }
        }

        function renderBoard(data) {
            const columns = {
                'pending': 'todo',
                'in_progress': 'in_progress',
                'needs_review': 'needs_review',
                'passing': 'passing'
            };

            Object.values(columns).forEach(id => {
                document.getElementById(id).innerHTML = '';
            });

            if (data.board) {
                Object.entries(data.board).forEach(([status, tasks]) => {
                    const columnId = columns[status] || status;
                    const column = document.getElementById(columnId);
                    if (column && tasks) {
                        tasks.forEach(task => {
                            column.appendChild(createTaskCard(task));
                        });
                    }
                });
            }

            document.getElementById('todo-count').textContent = data.board?.todo?.length || 0;
            document.getElementById('progress-count').textContent = data.board?.in_progress?.length || 0;
            document.getElementById('review-count').textContent = data.board?.review?.length || 0;
            document.getElementById('done-count').textContent = data.board?.done?.length || 0;

            if (data.stats) {
                document.getElementById('stats').textContent =
                    `${data.stats.passing}/${data.stats.total} complete (${data.stats.progress_percent}%)`;
            }
        }

        function createTaskCard(task) {
            const card = document.createElement('div');
            card.className = 'bg-gray-700 rounded-lg p-3 cursor-pointer hover:bg-gray-600 active:bg-gray-500 transition-colors touch-manipulation';
            card.draggable = true;
            card.dataset.id = task.id;
            card.ondragstart = (e) => drag(e, task.id);
            card.onclick = () => showTaskDetail(task);

            const priorityBadge = task.priority > 50
                ? '<span class="text-xs bg-red-500/20 text-red-400 px-1.5 py-0.5 rounded">High</span>'
                : '';

            card.innerHTML = `
                <div class="flex items-start justify-between gap-2">
                    <span class="font-medium text-sm">${task.name}</span>
                    ${priorityBadge}
                </div>
                ${task.description ? `<p class="text-xs text-gray-400 mt-1 line-clamp-2">${task.description}</p>` : ''}
                ${task.test_cases?.length ? `<div class="text-xs text-gray-500 mt-2">${task.test_cases.length} tests</div>` : ''}
            `;

            return card;
        }

        // Drag and drop
        function drag(event, taskId) {
            event.dataTransfer.setData('taskId', taskId);
            event.target.classList.add('dragging');
        }

        function allowDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        async function drop(event, newStatus) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            const taskId = event.dataTransfer.getData('taskId');
            document.querySelector('.dragging')?.classList.remove('dragging');

            try {
                await fetch(`${API_BASE}/task/${taskId}/move`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                refreshBoard();
            } catch (error) {
                console.error('Failed to move task:', error);
            }
        }

        // Task modals
        function showAddTask() {
            document.getElementById('add-task-modal').classList.remove('hidden');
            document.getElementById('add-task-modal').classList.add('flex');
        }

        function hideAddTask() {
            document.getElementById('add-task-modal').classList.add('hidden');
            document.getElementById('add-task-modal').classList.remove('flex');
        }

        async function addTask(event) {
            event.preventDefault();

            const task = {
                name: document.getElementById('task-name').value,
                description: document.getElementById('task-desc').value,
                test_cases: document.getElementById('task-tests').value.split('\n').filter(t => t.trim()),
                priority: 0
            };

            try {
                await fetch(`${API_BASE}/task`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(task)
                });
                hideAddTask();
                refreshBoard();
                document.getElementById('task-name').value = '';
                document.getElementById('task-desc').value = '';
                document.getElementById('task-tests').value = '';
            } catch (error) {
                console.error('Failed to add task:', error);
            }
        }

        function showTaskDetail(task) {
            currentTask = task;
            document.getElementById('detail-name').textContent = task.name;
            document.getElementById('detail-content').innerHTML = `
                <div>
                    <label class="text-xs text-gray-500">Status</label>
                    <p class="text-sm">${task.status}</p>
                </div>
                ${task.description ? `
                <div>
                    <label class="text-xs text-gray-500">Description</label>
                    <p class="text-sm">${task.description}</p>
                </div>
                ` : ''}
                ${task.test_cases?.length ? `
                <div>
                    <label class="text-xs text-gray-500">Test Cases</label>
                    <ul class="text-sm list-disc list-inside">
                        ${task.test_cases.map(tc => `<li>${tc}</li>`).join('')}
                    </ul>
                </div>
                ` : ''}
            `;
            document.getElementById('task-detail-modal').classList.remove('hidden');
            document.getElementById('task-detail-modal').classList.add('flex');
        }

        function hideTaskDetail() {
            document.getElementById('task-detail-modal').classList.add('hidden');
            document.getElementById('task-detail-modal').classList.remove('flex');
            currentTask = null;
        }

        function workOnTask() {
            if (currentTask) {
                showView('chat');
                quickPrompt(`Help me implement: ${currentTask.name}\n\nDescription: ${currentTask.description || 'None'}\n\nTest cases:\n${currentTask.test_cases?.join('\n') || 'None'}`);
                hideTaskDetail();
            }
        }

        // Chat functions
        function setLoading(loading) {
            isLoading = loading;
            const sendIcon = document.getElementById('send-icon');
            const stopIcon = document.getElementById('stop-icon');
            if (loading) {
                sendIcon.classList.add('hidden');
                stopIcon.classList.remove('hidden');
            } else {
                sendIcon.classList.remove('hidden');
                stopIcon.classList.add('hidden');
            }
        }

        function submitOrStop() {
            if (isLoading) {
                // Could implement abort controller here
                setLoading(false);
            } else {
                document.getElementById('chat-form').dispatchEvent(new Event('submit'));
            }
        }

        async function sendMessage(event) {
            event.preventDefault();
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message || isLoading) return;

            addChatMessage(message, 'user');
            input.value = '';
            autoResizeTextarea(input);
            setLoading(true);

            // Add loading indicator
            const loadingId = addLoadingMessage();

            try {
                const response = await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                const data = await response.json();
                removeLoadingMessage(loadingId);
                addChatMessage(data.response, 'assistant');
            } catch (error) {
                removeLoadingMessage(loadingId);
                addChatMessage('Error: Could not reach Claude', 'error');
            } finally {
                setLoading(false);
            }
        }

        function addLoadingMessage() {
            const container = document.getElementById('chat-messages');
            const msg = document.createElement('div');
            msg.id = 'loading-' + Date.now();
            msg.className = 'bg-gray-700 rounded-lg p-3 mr-4 md:mr-8';
            msg.innerHTML = `
                <div class="flex gap-1">
                    <span class="w-2 h-2 bg-gray-400 rounded-full loading-dot"></span>
                    <span class="w-2 h-2 bg-gray-400 rounded-full loading-dot"></span>
                    <span class="w-2 h-2 bg-gray-400 rounded-full loading-dot"></span>
                </div>
            `;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
            return msg.id;
        }

        function removeLoadingMessage(id) {
            const msg = document.getElementById(id);
            if (msg) msg.remove();
        }

        function addChatMessage(text, role) {
            const container = document.getElementById('chat-messages');
            const firstMessage = container.querySelector('.text-center');
            if (firstMessage) firstMessage.remove();

            const msg = document.createElement('div');
            msg.className = role === 'user'
                ? 'bg-blue-600 rounded-lg p-3 ml-4 md:ml-8'
                : role === 'error'
                ? 'bg-red-600/20 text-red-400 rounded-lg p-3'
                : 'bg-gray-700 rounded-lg p-3 mr-4 md:mr-8';

            const formatted = formatMessage(text);
            msg.innerHTML = `<div class="text-sm chat-content">${formatted}</div>`;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        function formatMessage(text) {
            let escaped = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');

            escaped = escaped.replace(/```(\w*)\n?([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre class="bg-gray-900 rounded p-3 my-2 overflow-x-auto text-xs font-mono"><code>${code.trim()}</code></pre>`;
            });

            escaped = escaped.replace(/`([^`]+)`/g, '<code class="bg-gray-900 px-1.5 py-0.5 rounded text-xs font-mono">$1</code>');
            escaped = escaped.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            escaped = escaped.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            escaped = escaped.replace(/\n/g, '<br>');

            return escaped;
        }

        function quickPrompt(text) {
            const input = document.getElementById('chat-input');
            input.value = text;
            autoResizeTextarea(input);
            document.getElementById('chat-form').dispatchEvent(new Event('submit'));
        }

        function handleChatKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                document.getElementById('chat-form').dispatchEvent(new Event('submit'));
            }
        }

        function autoResizeTextarea(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        }

        // Load chat history from server
        async function loadChatHistory() {
            try {
                const response = await fetch(`${API_BASE}/chat/history`);
                const data = await response.json();
                if (data.messages && data.messages.length > 0) {
                    const container = document.getElementById('chat-messages');
                    const firstMessage = container.querySelector('.text-center');
                    if (firstMessage) firstMessage.remove();

                    data.messages.forEach(msg => {
                        addChatMessage(msg.content, msg.role);
                    });
                }
            } catch (error) {
                console.error('Failed to load chat history:', error);
            }
        }

        // Clear chat history
        async function clearChat() {
            if (confirm('Clear chat history?')) {
                try {
                    await fetch(`${API_BASE}/chat/history`, { method: 'DELETE' });
                    document.getElementById('chat-messages').innerHTML = `
                        <div class="text-gray-500 text-sm text-center py-8">
                            Start a conversation with Claude
                        </div>
                    `;
                } catch (error) {
                    console.error('Failed to clear chat:', error);
                }
            }
        }

        // ===========================================
        // Project Switching
        // ===========================================

        function toggleProjectDropdown() {
            document.getElementById('project-dropdown').classList.toggle('hidden');
        }

        async function loadProjects() {
            try {
                const response = await fetch(`${API_BASE}/projects`);
                const data = await response.json();

                const list = document.getElementById('project-list');
                list.innerHTML = '';

                if (data.projects) {
                    data.projects.forEach(project => {
                        const btn = document.createElement('button');
                        btn.className = `w-full text-left px-3 py-2 hover:bg-gray-700 text-sm ${project.current ? 'text-blue-400' : ''}`;
                        btn.innerHTML = project.current
                            ? `<span class="mr-1">●</span> ${project.name}`
                            : project.name;
                        btn.onclick = () => switchProject(project.path);
                        list.appendChild(btn);

                        if (project.current) {
                            document.getElementById('current-project').textContent = project.name;
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to load projects:', error);
            }
        }

        async function switchProject(path) {
            try {
                const response = await fetch(`${API_BASE}/projects/switch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path })
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('current-project').textContent = data.project;
                    document.getElementById('project-dropdown').classList.add('hidden');

                    // Reload everything for new project
                    refreshBoard();
                    fetchBranchName();
                    loadChatHistory();
                    loadProjects();
                }
            } catch (error) {
                console.error('Failed to switch project:', error);
            }
        }

        // ===========================================
        // Session Management
        // ===========================================

        async function checkSession() {
            try {
                const response = await fetch(`${API_BASE}/session/ping`, { method: 'POST' });
                const data = await response.json();

                if (data.summary) {
                    // Show welcome back message in chat
                    showView('chat');
                    addChatMessage(data.summary, 'assistant');
                }
            } catch (error) {
                console.error('Failed to check session:', error);
            }
        }

        // ===========================================
        // MCP & Skills Management
        // ===========================================

        async function loadMcpServers() {
            try {
                const response = await fetch(`${API_BASE}/claude/mcp`);
                const data = await response.json();

                const list = document.getElementById('mcp-servers-list');
                list.innerHTML = '';

                if (data.servers && data.servers.length > 0) {
                    data.servers.forEach(server => {
                        const div = document.createElement('div');
                        div.className = 'flex items-center justify-between p-2 bg-gray-800 rounded-lg';
                        div.innerHTML = `
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-medium truncate">${server.name}</div>
                                <div class="text-xs text-gray-500">${server.scope}</div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer ml-2">
                                <input type="checkbox" ${server.enabled ? 'checked' : ''} onchange="toggleMcp('${server.name}', '${server.scope}', this.checked)" class="sr-only peer">
                                <div class="w-9 h-5 bg-gray-600 peer-focus:ring-2 peer-focus:ring-blue-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        `;
                        list.appendChild(div);
                    });
                } else {
                    list.innerHTML = '<div class="text-sm text-gray-500">No MCP servers configured</div>';
                }
            } catch (error) {
                console.error('Failed to load MCP servers:', error);
            }
        }

        async function toggleMcp(name, scope, enabled) {
            try {
                await fetch(`${API_BASE}/claude/mcp/${name}/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scope, enabled })
                });
            } catch (error) {
                console.error('Failed to toggle MCP server:', error);
            }
        }

        function showAddMcpModal() {
            document.getElementById('add-mcp-modal').classList.remove('hidden');
            document.getElementById('add-mcp-modal').classList.add('flex');
        }

        function hideAddMcpModal() {
            document.getElementById('add-mcp-modal').classList.add('hidden');
            document.getElementById('add-mcp-modal').classList.remove('flex');
        }

        async function addMcpServer(event) {
            event.preventDefault();

            const data = {
                name: document.getElementById('mcp-name').value,
                command: document.getElementById('mcp-command').value,
                args: document.getElementById('mcp-args').value.split(' ').filter(a => a),
                scope: document.getElementById('mcp-scope').value
            };

            try {
                await fetch(`${API_BASE}/claude/mcp`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                hideAddMcpModal();
                loadMcpServers();

                // Clear form
                document.getElementById('mcp-name').value = '';
                document.getElementById('mcp-command').value = '';
                document.getElementById('mcp-args').value = '';
            } catch (error) {
                console.error('Failed to add MCP server:', error);
            }
        }

        async function loadSkills() {
            try {
                const response = await fetch(`${API_BASE}/claude/skills`);
                const data = await response.json();

                const list = document.getElementById('skills-list');
                list.innerHTML = '';

                if (data.skills && data.skills.length > 0) {
                    data.skills.forEach(skill => {
                        const div = document.createElement('div');
                        div.className = 'p-2 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700';
                        div.onclick = () => viewSkill(skill.file);
                        div.innerHTML = `
                            <div class="text-sm font-medium">${skill.name}</div>
                            <div class="text-xs text-gray-500">${skill.description || skill.scope}</div>
                        `;
                        list.appendChild(div);
                    });
                } else {
                    list.innerHTML = '<div class="text-sm text-gray-500">No skills created yet</div>';
                }
            } catch (error) {
                console.error('Failed to load skills:', error);
            }
        }

        async function viewSkill(filePath) {
            try {
                const response = await fetch(`${API_BASE}/claude/skills${filePath}`);
                const data = await response.json();
                if (data.content) {
                    showView('chat');
                    addChatMessage('**Skill Content:**\n```markdown\n' + data.content + '\n```', 'assistant');
                }
            } catch (error) {
                console.error('Failed to view skill:', error);
            }
        }

        function showAddSkillModal() {
            document.getElementById('add-skill-modal').classList.remove('hidden');
            document.getElementById('add-skill-modal').classList.add('flex');
        }

        function hideAddSkillModal() {
            document.getElementById('add-skill-modal').classList.add('hidden');
            document.getElementById('add-skill-modal').classList.remove('flex');
        }

        async function addSkill(event) {
            event.preventDefault();

            const data = {
                name: document.getElementById('skill-name').value,
                description: document.getElementById('skill-description').value,
                trigger: document.getElementById('skill-trigger').value,
                solution: document.getElementById('skill-solution').value,
                scope: document.getElementById('skill-scope').value
            };

            try {
                await fetch(`${API_BASE}/claude/skills`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                hideAddSkillModal();
                loadSkills();

                // Clear form
                document.getElementById('skill-name').value = '';
                document.getElementById('skill-description').value = '';
                document.getElementById('skill-trigger').value = '';
                document.getElementById('skill-solution').value = '';
            } catch (error) {
                console.error('Failed to create skill:', error);
            }
        }
    </script>
</body>
</html>
