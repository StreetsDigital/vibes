#!/usr/bin/env bash
#
# vibecode - The Vibecoding Stack CLI
# ====================================
# One command to rule them all.
#
# Usage:
#   vibecode install [--server]      - Install the full stack
#   vibecode setup                   - Configure credentials (OpenAI)
#   vibecode new <project> [profile] - Create isolated project
#   vibecode shell <project>         - Enter project shell
#   vibecode code <project>          - Start Claude Code in project
#   vibecode list                    - List projects
#   vibecode status [project]        - Show status
#   vibecode dashboard [port]        - Start web dashboard
#   vibecode help                    - Show help
#

set -e

VERSION="2.0.0"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Helpers
echo_step() { echo -e "${BLUE}==>${NC} $1"; }
echo_success() { echo -e "${GREEN}✓${NC} $1"; }
echo_warning() { echo -e "${YELLOW}!${NC} $1"; }
echo_error() { echo -e "${RED}✗${NC} $1"; }
echo_info() { echo -e "${DIM}$1${NC}"; }

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CLAUDEBOX_HOME="${HOME}/claudebox"

# =============================================================================
# BANNER
# =============================================================================

show_banner() {
    echo ""
    echo -e "${MAGENTA}  ╦  ╦╦╔╗ ╔═╗╔═╗╔═╗╔╦╗╔═╗${NC}"
    echo -e "${MAGENTA}  ╚╗╔╝║╠╩╗║╣ ║  ║ ║ ║║║╣ ${NC}"
    echo -e "${MAGENTA}   ╚╝ ╩╚═╝╚═╝╚═╝╚═╝═╩╝╚═╝${NC}"
    echo -e "${DIM}  Autonomous coding with quality gates${NC}"
    echo ""
}

show_mini_banner() {
    echo -e "${MAGENTA}vibecode${NC} ${DIM}v${VERSION}${NC}"
}

# =============================================================================
# INSTALL COMMAND (merged from install.sh)
# =============================================================================

cmd_install() {
    SERVER_MODE=false
    DOMAIN=""

    # Parse args
    while [[ $# -gt 0 ]]; do
        case $1 in
            --server) SERVER_MODE=true; shift ;;
            --domain) DOMAIN="$2"; shift; shift ;;
            *) shift ;;
        esac
    done

    show_banner

    if [ "$SERVER_MODE" = true ]; then
        echo -e "  ${CYAN}Mode:${NC} Server deployment"
        [ -n "$DOMAIN" ] && echo -e "  ${CYAN}Domain:${NC} $DOMAIN"
    else
        echo -e "  ${CYAN}Mode:${NC} Local development"
    fi
    echo ""

    # Configuration
    VIBES_USER="vibes"
    VIBES_HOME="/home/${VIBES_USER}"
    PROJECTS_DIR="${VIBES_HOME}/projects"
    AUTOCODER_DIR="${AUTOCODER_DIR:-$HOME/autocoder}"
    PLANNING_DIR="${PLANNING_DIR:-$HOME/.claude/skills/planning-with-files}"

    # =========================================================================
    # SERVER MODE: System setup
    # =========================================================================

    if [ "$SERVER_MODE" = true ]; then
        if [[ $EUID -ne 0 ]]; then
            echo_error "Server install requires root. Use: sudo vibecode install --server"
            exit 1
        fi

        echo_step "Installing system packages..."
        apt update -qq && apt install -y -qq \
            curl wget git htop tmux vim unzip jq \
            ca-certificates gnupg lsb-release \
            python3 python3-pip python3-venv build-essential \
            > /dev/null 2>&1
        echo_success "System packages"

        # Docker
        echo_step "Setting up Docker..."
        if ! command -v docker &> /dev/null; then
            install -m 0755 -d /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg 2>/dev/null
            chmod a+r /etc/apt/keyrings/docker.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
            apt update -qq && apt install -y -qq docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin > /dev/null
            systemctl enable docker && systemctl start docker
        fi
        echo_success "Docker"

        # Node.js
        echo_step "Setting up Node.js..."
        if ! command -v node &> /dev/null; then
            curl -fsSL https://deb.nodesource.com/setup_20.x | bash - > /dev/null 2>&1
            apt install -y -qq nodejs > /dev/null
        fi
        echo_success "Node.js $(node --version 2>/dev/null || echo 'installed')"

        # Vibes user
        echo_step "Creating vibes user..."
        if ! id "${VIBES_USER}" &>/dev/null; then
            useradd -m -s /bin/bash "${VIBES_USER}"
        fi
        usermod -aG docker "${VIBES_USER}"
        echo_success "User: ${VIBES_USER}"

        # Directories
        mkdir -p "${PROJECTS_DIR}" "${VIBES_HOME}/.claude/logs" "${VIBES_HOME}/.claude/skills/learned"
        chown -R "${VIBES_USER}:${VIBES_USER}" "${VIBES_HOME}"

        # Firewall
        if command -v ufw &> /dev/null; then
            ufw --force enable > /dev/null 2>&1
            ufw allow ssh > /dev/null 2>&1
            ufw allow http > /dev/null 2>&1
            ufw allow https > /dev/null 2>&1
        fi

        AUTOCODER_DIR="${VIBES_HOME}/autocoder"
        PLANNING_DIR="${VIBES_HOME}/.claude/skills/planning-with-files"
    fi

    # =========================================================================
    # Common setup
    # =========================================================================

    echo_step "Checking prerequisites..."

    command -v python3 &>/dev/null && echo_success "Python $(python3 --version 2>&1 | cut -d' ' -f2)" || { echo_error "Python3 required"; exit 1; }
    command -v git &>/dev/null && echo_success "Git" || { echo_error "Git required"; exit 1; }

    # Claude CLI
    echo_step "Installing Claude Code CLI..."
    if ! command -v claude &> /dev/null; then
        npm install -g @anthropic-ai/claude-code > /dev/null 2>&1 || echo_warning "Install manually: npm i -g @anthropic-ai/claude-code"
    fi
    command -v claude &>/dev/null && echo_success "Claude CLI"

    # Python deps
    echo_step "Installing Python dependencies..."
    PIP_INSTALL="pip3 install --user --break-system-packages --quiet"
    $PIP_INSTALL sqlalchemy mcp psutil 2>/dev/null || true
    $PIP_INSTALL "aleph-rlm[mcp]" 2>/dev/null || $PIP_INSTALL "git+https://github.com/Hmbown/aleph.git#egg=aleph-rlm[mcp]" 2>/dev/null || true
    echo_success "Python dependencies"

    # =========================================================================
    # Repository setup
    # =========================================================================

    run_as_user() {
        if [ "$SERVER_MODE" = true ]; then
            su - "${VIBES_USER}" -c "$1"
        else
            eval "$1"
        fi
    }

    echo_step "Setting up repositories..."

    # Autocoder
    if [ ! -d "$AUTOCODER_DIR" ]; then
        run_as_user "git clone -q https://github.com/leonvanzyl/autocoder.git \"$AUTOCODER_DIR\""
    fi
    echo_success "Autocoder"

    # Planning skill
    SKILLS_DIR="$(dirname "$PLANNING_DIR")"
    run_as_user "mkdir -p \"$SKILLS_DIR\""
    if [ ! -d "$PLANNING_DIR" ]; then
        run_as_user "git clone -q https://github.com/OthmanAdi/planning-with-files.git /tmp/pwf && cp -r /tmp/pwf/skills/planning-with-files \"$PLANNING_DIR\" && rm -rf /tmp/pwf"
    fi
    echo_success "Planning skill"

    # =========================================================================
    # Integration files
    # =========================================================================

    echo_step "Installing integration files..."
    run_as_user "mkdir -p \"$AUTOCODER_DIR/mcp_server\""

    if [ -d "$SCRIPT_DIR/mcp_server" ]; then
        run_as_user "cp \"$SCRIPT_DIR/mcp_server/\"* \"$AUTOCODER_DIR/mcp_server/\" 2>/dev/null || true"
    fi

    if [ -f "$SCRIPT_DIR/CLAUDE.md" ]; then
        run_as_user "cp \"$SCRIPT_DIR/CLAUDE.md\" \"$AUTOCODER_DIR/\""
    fi
    echo_success "Integration files"

    # =========================================================================
    # Claude configuration
    # =========================================================================

    echo_step "Configuring Claude..."

    CLAUDE_CONFIG_DIR="$HOME/.claude"
    [ "$SERVER_MODE" = true ] && CLAUDE_CONFIG_DIR="${VIBES_HOME}/.claude"

    run_as_user "mkdir -p \"$CLAUDE_CONFIG_DIR\""

    run_as_user "cat > \"$CLAUDE_CONFIG_DIR/mcp_servers.json\" << 'EOFCFG'
{
  \"mcpServers\": {
    \"vibecoding-orchestrator\": {
      \"command\": \"python3\",
      \"args\": [\"$AUTOCODER_DIR/mcp_server/vibecoding_server.py\"],
      \"env\": {\"PYTHONPATH\": \"$AUTOCODER_DIR/mcp_server\"}
    },
    \"atom-of-thoughts\": {
      \"command\": \"npx\",
      \"args\": [\"-y\", \"@kbsooo/mcp-atom-of-thoughts\"]
    },
    \"sequential-thinking\": {
      \"command\": \"npx\",
      \"args\": [\"-y\", \"@modelcontextprotocol/server-sequentialthinking\"]
    },
    \"context7\": {
      \"command\": \"npx\",
      \"args\": [\"-y\", \"@upstash/context7-mcp@latest\"]
    }
  },
  \"thinking\": {
    \"enabled\": true,
    \"preTaskAnalysis\": true
  }
}
EOFCFG"
    echo_success "MCP servers configured"

    # Commands and skills
    echo_step "Installing commands and skills..."
    run_as_user "mkdir -p \"$CLAUDE_CONFIG_DIR/commands\" \"$CLAUDE_CONFIG_DIR/skills/learned\""

    # Copy commands if they exist
    if [ -d "$SCRIPT_DIR/.claude/commands" ]; then
        for cmd in "$SCRIPT_DIR/.claude/commands/"*; do
            [ -f "$cmd" ] && run_as_user "cp \"$cmd\" \"$CLAUDE_CONFIG_DIR/commands/\""
        done
    fi
    echo_success "Commands installed (/commit, /verify, /retrospective)"

    # Quality gate config
    if [ -f "$SCRIPT_DIR/quality-gate.config.json" ]; then
        run_as_user "cp \"$SCRIPT_DIR/quality-gate.config.json\" \"$AUTOCODER_DIR/\""
    fi

    # Pre-commit hook
    if [ -f "$SCRIPT_DIR/hooks/pre-commit" ]; then
        run_as_user "mkdir -p \"$AUTOCODER_DIR/hooks\""
        run_as_user "cp \"$SCRIPT_DIR/hooks/pre-commit\" \"$AUTOCODER_DIR/hooks/\""
    fi
    echo_success "Quality gates configured"

    # =========================================================================
    # Server-specific setup
    # =========================================================================

    if [ "$SERVER_MODE" = true ]; then
        # Environment file
        if [ -f "${SCRIPT_DIR}/deploy/env.example" ] && [ ! -f "${SCRIPT_DIR}/deploy/.env" ]; then
            cp "${SCRIPT_DIR}/deploy/env.example" "${SCRIPT_DIR}/deploy/.env"
            SECRET_KEY=$(openssl rand -hex 32 2>/dev/null || echo "change-me")
            sed -i "s/SECRET_KEY=.*/SECRET_KEY=${SECRET_KEY}/" "${SCRIPT_DIR}/deploy/.env"
            sed -i "s|PROJECTS_DIR=.*|PROJECTS_DIR=${PROJECTS_DIR}|" "${SCRIPT_DIR}/deploy/.env"
            [ -n "$DOMAIN" ] && sed -i "s/DOMAIN=.*/DOMAIN=${DOMAIN}/" "${SCRIPT_DIR}/deploy/.env"
            chown "${VIBES_USER}:${VIBES_USER}" "${SCRIPT_DIR}/deploy/.env"
            chmod 600 "${SCRIPT_DIR}/deploy/.env"
        fi

        # tmux config
        cat > "${VIBES_HOME}/.tmux.conf" << 'EOF'
set -g mouse on
set -g history-limit 50000
set -g base-index 1
set -g status-bg black
set -g status-fg white
bind | split-window -h
bind - split-window -v
EOF
        chown "${VIBES_USER}:${VIBES_USER}" "${VIBES_HOME}/.tmux.conf"
    fi

    # =========================================================================
    # Done!
    # =========================================================================

    echo ""
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${GREEN}  Installation complete!${NC}"
    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    if [ "$SERVER_MODE" = true ]; then
        echo -e "  ${BOLD}What's installed:${NC}"
        echo "    Autocoder      ${DIM}${AUTOCODER_DIR}${NC}"
        echo "    MCP Server     ${DIM}Feature queue, Aleph, Quality gates${NC}"
        echo "    Planning       ${DIM}${PLANNING_DIR}${NC}"
        echo ""
        echo -e "  ${BOLD}Next steps:${NC}"
        echo ""
        echo "    ${CYAN}1.${NC} Configure credentials:"
        echo -e "       ${GREEN}vibecode setup${NC}"
        echo ""
        echo "    ${CYAN}2.${NC} Start the stack:"
        echo -e "       ${GREEN}cd ${SCRIPT_DIR}/deploy && docker compose up -d${NC}"
        echo ""
        echo "    ${CYAN}3.${NC} Start coding:"
        echo -e "       ${GREEN}su - vibes${NC}"
        echo -e "       ${GREEN}cd ~/autocoder && claude${NC}"
        echo ""
        if [ -n "$DOMAIN" ]; then
            echo -e "  ${BOLD}Access:${NC}"
            echo "    Dashboard  ${CYAN}https://$DOMAIN${NC}"
        fi
    else
        echo -e "  ${BOLD}What's installed:${NC}"
        echo "    Autocoder      ${DIM}${AUTOCODER_DIR}${NC}"
        echo "    MCP Server     ${DIM}Feature queue, Aleph, Quality gates${NC}"
        echo "    Planning       ${DIM}${PLANNING_DIR}${NC}"
        echo ""
        echo -e "  ${BOLD}Start coding:${NC}"
        echo ""
        echo -e "    ${GREEN}cd $AUTOCODER_DIR && claude${NC}"
        echo ""
    fi

    echo -e "  ${BOLD}Available tools:${NC}"
    echo "    feature_get_next      ${DIM}Get next task from queue${NC}"
    echo "    aleph_search          ${DIM}Search codebase with context${NC}"
    echo "    quality_check         ${DIM}Run lint/types/tests${NC}"
    echo "    feature_mark_passing  ${DIM}Complete a feature${NC}"
    echo ""
    echo "  ${DIM}See CLAUDE.md for the full workflow.${NC}"
    echo ""
}

# =============================================================================
# SETUP COMMAND (credentials)
# =============================================================================

cmd_setup() {
    show_banner
    echo "  Configure your credentials"
    echo ""

    # Check current status
    OPENAI_OK=false
    [ -f "$HOME/.config/openai/api_key" ] && [ -s "$HOME/.config/openai/api_key" ] && OPENAI_OK=true

    echo "  Current status:"
    $OPENAI_OK && echo -e "    ${GREEN}✓${NC} OpenAI API key" || echo -e "    ${DIM}○${NC} OpenAI API key"
    echo ""

    # OpenAI
    if ! $OPENAI_OK; then
        echo -e "  ${BOLD}OpenAI API Key${NC} ${DIM}(for /codex-review bug detection)${NC}"
        echo ""
        read -p "  Have OpenAI API key? (y/n): " HAS_OPENAI
        if [[ "$HAS_OPENAI" =~ ^[Yy] ]]; then
            read -p "  API Key: " OPENAI_KEY
            if [ -n "$OPENAI_KEY" ]; then
                mkdir -p "$HOME/.config/openai"
                echo "$OPENAI_KEY" > "$HOME/.config/openai/api_key"
                chmod 600 "$HOME/.config/openai/api_key"
                echo_success "OpenAI API key saved"
            fi
        fi
        echo ""
    fi

    echo -e "${GREEN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo "  Ready to go:"
    echo -e "    ${GREEN}vibecode dashboard 8080${NC}  ${DIM}Start web dashboard${NC}"
    echo -e "    ${GREEN}cd ~/autocoder && claude${NC}  ${DIM}Start coding${NC}"
    echo ""
}

# =============================================================================
# PROJECT COMMANDS
# =============================================================================

cmd_init() {
    show_mini_banner
    echo_step "Initializing Vibecoding Stack..."

    # Check claudebox
    if ! command -v claudebox &> /dev/null; then
        echo_step "Installing ClaudeBox..."
        INSTALLER="/tmp/claudebox.run"
        curl -fsSL "https://github.com/RchGrav/claudebox/releases/latest/download/claudebox.run" -o "$INSTALLER"
        chmod +x "$INSTALLER" && "$INSTALLER"
    fi
    echo_success "ClaudeBox ready"

    # Python deps
    pip3 install --user --quiet --break-system-packages sqlalchemy mcp 2>/dev/null || true
    echo_success "Dependencies ready"

    # Link vibecode globally
    if [ -w "/usr/local/bin" ]; then
        ln -sf "$SCRIPT_DIR/vibecode" "/usr/local/bin/vibecode"
        echo_success "vibecode linked to /usr/local/bin"
    fi

    echo ""
    echo -e "Next: ${GREEN}vibecode new <project-name>${NC}"
}

cmd_new() {
    [ -z "$1" ] && { echo_error "Usage: vibecode new <project> [profile]"; exit 1; }

    PROJECT_NAME="$1"
    PROFILE="${2:-python}"

    show_mini_banner
    echo -e "Creating ${GREEN}$PROJECT_NAME${NC} (${BLUE}$PROFILE${NC})"
    echo ""

    command -v claudebox &>/dev/null || { echo_error "Run: vibecode init"; exit 1; }

    mkdir -p "$HOME/.claude/skills/learned"

    echo_step "Creating container..."
    claudebox new "$PROJECT_NAME" --profile "$PROFILE"

    echo_step "Installing stack..."
    cat > "$CLAUDEBOX_HOME/$PROJECT_NAME/.install-vibecoding.sh" << 'EOF'
#!/bin/bash
set -e
cd /workspace
[ ! -d "autocoder" ] && git clone -q https://github.com/leonvanzyl/autocoder.git autocoder
mkdir -p ~/.claude/skills
[ ! -d ~/.claude/skills/planning-with-files ] && {
    git clone -q https://github.com/OthmanAdi/planning-with-files.git /tmp/p
    cp -r /tmp/p/planning-with-files ~/.claude/skills/
    rm -rf /tmp/p
}
echo "Done"
EOF
    chmod +x "$CLAUDEBOX_HOME/$PROJECT_NAME/.install-vibecoding.sh"
    claudebox exec "$PROJECT_NAME" /workspace/.install-vibecoding.sh

    # Copy all Claude configuration
    PROJ_CLAUDE="$CLAUDEBOX_HOME/$PROJECT_NAME/workspace/.claude"
    mkdir -p "$PROJ_CLAUDE/commands" "$PROJ_CLAUDE/skills/learned"

    echo_step "Copying configuration..."

    # Settings
    [ -f "$SCRIPT_DIR/.claude/settings.json" ] && {
        cp "$SCRIPT_DIR/.claude/settings.json" "$PROJ_CLAUDE/"
    }

    # MCP Servers
    [ -f "$SCRIPT_DIR/.claude/mcp_servers.json" ] && {
        cp "$SCRIPT_DIR/.claude/mcp_servers.json" "$PROJ_CLAUDE/"
    }

    # Commands (skills like /commit, /verify, etc.)
    [ -d "$SCRIPT_DIR/.claude/commands" ] && {
        cp -r "$SCRIPT_DIR/.claude/commands/"* "$PROJ_CLAUDE/commands/" 2>/dev/null || true
    }

    # Quality gate config
    [ -f "$SCRIPT_DIR/quality-gate.config.json" ] && {
        cp "$SCRIPT_DIR/quality-gate.config.json" "$CLAUDEBOX_HOME/$PROJECT_NAME/workspace/"
    }

    # Pre-commit hook
    [ -f "$SCRIPT_DIR/hooks/pre-commit" ] && {
        mkdir -p "$CLAUDEBOX_HOME/$PROJECT_NAME/workspace/hooks"
        cp "$SCRIPT_DIR/hooks/pre-commit" "$CLAUDEBOX_HOME/$PROJECT_NAME/workspace/hooks/"
    }

    # MCP Server files
    [ -d "$SCRIPT_DIR/mcp_server" ] && {
        mkdir -p "$CLAUDEBOX_HOME/$PROJECT_NAME/workspace/mcp_server"
        cp "$SCRIPT_DIR/mcp_server/"*.py "$CLAUDEBOX_HOME/$PROJECT_NAME/workspace/mcp_server/" 2>/dev/null || true
    }

    echo_success "Configuration copied"

    echo ""
    echo_success "Project ready!"
    echo ""
    echo -e "  ${BOLD}Included:${NC}"
    echo -e "    ${GREEN}✓${NC} MCP Servers (vibecoding, atom-of-thoughts, sequential-thinking)"
    echo -e "    ${GREEN}✓${NC} Commands (/commit, /verify, /retrospective)"
    echo -e "    ${GREEN}✓${NC} Quality Gates (pre-commit hooks)"
    echo -e "    ${GREEN}✓${NC} Planning Skill"
    echo ""
    echo -e "  ${GREEN}vibecode shell $PROJECT_NAME${NC}  Enter shell"
    echo -e "  ${GREEN}vibecode code $PROJECT_NAME${NC}   Start Claude Code"
    echo ""
}

cmd_shell() {
    [ -z "$1" ] && { echo_error "Usage: vibecode shell <project>"; exit 1; }
    [ ! -d "$CLAUDEBOX_HOME/$1" ] && { echo_error "Project not found: $1"; exit 1; }
    claudebox shell "$1"
}

cmd_code() {
    [ -z "$1" ] && { echo_error "Usage: vibecode code <project>"; exit 1; }
    [ ! -d "$CLAUDEBOX_HOME/$1" ] && { echo_error "Project not found: $1"; exit 1; }
    claudebox exec "$1" "cd /workspace && claude"
}

cmd_list() {
    show_mini_banner
    echo ""

    if [ ! -d "$CLAUDEBOX_HOME" ] || [ -z "$(ls -A "$CLAUDEBOX_HOME" 2>/dev/null)" ]; then
        echo "  No projects yet."
        echo "  Create one: ${GREEN}vibecode new <name>${NC}"
        echo ""
        return
    fi

    for project in "$CLAUDEBOX_HOME"/*; do
        [ -d "$project" ] || continue
        NAME=$(basename "$project")
        SIZE=$(du -sh "$project" 2>/dev/null | cut -f1)

        if [ -f "$project/workspace/autocoder/mcp_server/vibecoding_server.py" ]; then
            echo -e "  ${GREEN}●${NC} ${BOLD}$NAME${NC} ${DIM}($SIZE)${NC}"
        else
            echo -e "  ${YELLOW}●${NC} ${BOLD}$NAME${NC} ${DIM}($SIZE, no stack)${NC}"
        fi
    done
    echo ""
}

cmd_status() {
    [ -z "$1" ] && { cmd_list; return; }
    [ ! -d "$CLAUDEBOX_HOME/$1" ] && { echo_error "Project not found: $1"; exit 1; }

    show_mini_banner
    echo ""
    echo -e "  Project: ${BOLD}$1${NC}"
    echo ""

    P="$CLAUDEBOX_HOME/$1"
    C="$P/workspace/.claude"

    echo -e "  ${BOLD}Core:${NC}"
    [ -d "$P/workspace/autocoder" ] && echo -e "    ${GREEN}✓${NC} Autocoder" || echo -e "    ${RED}✗${NC} Autocoder"
    [ -d "$C" ] && echo -e "    ${GREEN}✓${NC} Claude Config" || echo -e "    ${RED}✗${NC} Claude Config"

    echo ""
    echo -e "  ${BOLD}MCP Servers:${NC}"
    [ -f "$P/workspace/mcp_server/vibecoding_server.py" ] && echo -e "    ${GREEN}✓${NC} vibecoding-orchestrator" || echo -e "    ${DIM}○${NC} vibecoding-orchestrator"
    [ -f "$C/mcp_servers.json" ] && {
        grep -q "atom-of-thoughts" "$C/mcp_servers.json" && echo -e "    ${GREEN}✓${NC} atom-of-thoughts" || echo -e "    ${DIM}○${NC} atom-of-thoughts"
        grep -q "sequential-thinking" "$C/mcp_servers.json" && echo -e "    ${GREEN}✓${NC} sequential-thinking" || echo -e "    ${DIM}○${NC} sequential-thinking"
    }

    echo ""
    echo -e "  ${BOLD}Commands:${NC}"
    [ -f "$C/commands/commit.md" ] && echo -e "    ${GREEN}✓${NC} /commit" || echo -e "    ${DIM}○${NC} /commit"
    [ -f "$C/commands/verify.md" ] && echo -e "    ${GREEN}✓${NC} /verify" || echo -e "    ${DIM}○${NC} /verify"
    [ -f "$C/commands/retrospective.md" ] && echo -e "    ${GREEN}✓${NC} /retrospective" || echo -e "    ${DIM}○${NC} /retrospective"

    echo ""
    echo -e "  ${BOLD}Quality:${NC}"
    [ -f "$P/workspace/quality-gate.config.json" ] && echo -e "    ${GREEN}✓${NC} Quality Gate Config" || echo -e "    ${DIM}○${NC} Quality Gate Config"
    [ -f "$P/workspace/hooks/pre-commit" ] && echo -e "    ${GREEN}✓${NC} Pre-commit Hook" || echo -e "    ${DIM}○${NC} Pre-commit Hook"

    echo ""
    echo -e "  ${BOLD}Skills:${NC}"
    [ -d "$C/skills/planning-with-files" ] && echo -e "    ${GREEN}✓${NC} Planning Skill" || echo -e "    ${DIM}○${NC} Planning Skill"
    LEARNED_COUNT=$(find "$C/skills/learned" -name "*.md" 2>/dev/null | wc -l)
    echo -e "    ${DIM}$LEARNED_COUNT learned skills${NC}"

    echo ""
    echo -e "  Size: $(du -sh "$P" 2>/dev/null | cut -f1)"
    echo ""
}

cmd_remove() {
    [ -z "$1" ] && { echo_error "Usage: vibecode remove <project>"; exit 1; }
    [ ! -d "$CLAUDEBOX_HOME/$1" ] && { echo_error "Project not found: $1"; exit 1; }

    echo_warning "This will DELETE: $1"
    read -p "Type 'yes' to confirm: " CONFIRM
    [ "$CONFIRM" = "yes" ] || { echo "Cancelled"; exit 0; }

    claudebox remove "$1"
    echo_success "Removed: $1"
}

cmd_dashboard() {
    PORT="${1:-8080}"

    [ ! -f "$SCRIPT_DIR/dashboard/server.py" ] && { echo_error "Dashboard not found"; exit 1; }

    mkdir -p "$HOME/.claude/logs"

    echo_step "Starting dashboard on port $PORT..."
    python3 "$SCRIPT_DIR/dashboard/server.py" "$PORT"
}

# =============================================================================
# HELP
# =============================================================================

cmd_help() {
    show_banner
    echo -e "  ${BOLD}Usage:${NC} vibecode <command> [options]"
    echo ""
    echo -e "  ${BOLD}Getting Started:${NC}"
    echo -e "    ${GREEN}install${NC} [--server]        Install the full vibecoding stack"
    echo -e "    ${GREEN}setup${NC}                     Configure credentials (OpenAI)"
    echo ""
    echo -e "  ${BOLD}Projects (isolated containers):${NC}"
    echo -e "    ${GREEN}init${NC}                      Install ClaudeBox for isolation"
    echo -e "    ${GREEN}new${NC} <name> [profile]      Create new project"
    echo -e "    ${GREEN}shell${NC} <name>              Enter project shell"
    echo -e "    ${GREEN}code${NC} <name>               Start Claude Code in project"
    echo -e "    ${GREEN}list${NC}                      List all projects"
    echo -e "    ${GREEN}status${NC} [name]             Show project status"
    echo -e "    ${GREEN}remove${NC} <name>             Delete project"
    echo ""
    echo -e "  ${BOLD}Server:${NC}"
    echo -e "    ${GREEN}dashboard${NC} [port]          Start web dashboard"
    echo ""
    echo -e "  ${BOLD}Examples:${NC}"
    echo -e "    vibecode install --server        ${DIM}Full server setup${NC}"
    echo -e "    vibecode new my-api python       ${DIM}Create Python project${NC}"
    echo -e "    vibecode shell my-api            ${DIM}Enter project${NC}"
    echo -e "    vibecode dashboard 8080          ${DIM}Start dashboard${NC}"
    echo ""
    echo -e "  ${DIM}Profiles: python, javascript, go, rust, java, php, ruby, c, cpp${NC}"
    echo ""
}

# =============================================================================
# MAIN
# =============================================================================

COMMAND="${1:-help}"

case "$COMMAND" in
    install)      shift; cmd_install "$@" ;;
    setup)        cmd_setup ;;
    init)         cmd_init ;;
    new)          shift; cmd_new "$@" ;;
    shell)        shift; cmd_shell "$@" ;;
    code)         shift; cmd_code "$@" ;;
    list|ls)      cmd_list ;;
    status)       shift; cmd_status "$@" ;;
    remove|rm)    shift; cmd_remove "$@" ;;
    dashboard)    shift; cmd_dashboard "$@" ;;
    help|--help|-h) cmd_help ;;
    -v|--version) echo "vibecode $VERSION" ;;
    *)
        echo_error "Unknown command: $COMMAND"
        echo -e "Run: ${GREEN}vibecode help${NC}"
        exit 1
        ;;
esac
