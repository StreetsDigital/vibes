#!/usr/bin/env bash
#
# Vibecode - Unified Vibecoding Stack Manager
# ============================================
# One script to rule them all
#
# Usage:
#   vibecode init                    - Install claudebox + vibecoding stack
#   vibecode new <project> [profile] - Create new isolated project
#   vibecode shell <project>         - Enter project environment
#   vibecode list                    - List all projects
#   vibecode remove <project>        - Remove project
#   vibecode status [project]        - Show project status
#   vibecode lightsail <subcommand>  - Mobile/Lightsail setup
#   vibecode dashboard [port]        - Start web dashboard
#   vibecode help                    - Show this help
#

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# Helpers
echo_step() { echo -e "${BLUE}==>${NC} $1"; }
echo_success() { echo -e "${GREEN}✓${NC} $1"; }
echo_warning() { echo -e "${YELLOW}⚠${NC} $1"; }
echo_error() { echo -e "${RED}✗${NC} $1"; }
echo_info() { echo -e "${CYAN}ℹ${NC} $1"; }

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CLAUDEBOX_HOME="${HOME}/claudebox"

# =============================================================================
# BANNER
# =============================================================================

show_banner() {
    echo ""
    echo -e "${MAGENTA}╔══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${MAGENTA}║                  VIBECODE MANAGER                            ║${NC}"
    echo -e "${MAGENTA}║                                                              ║${NC}"
    echo -e "${MAGENTA}║  Isolated coding environments with full vibecoding stack    ║${NC}"
    echo -e "${MAGENTA}╚══════════════════════════════════════════════════════════════╝${NC}"
    echo ""
}

# =============================================================================
# LIGHTSAIL / MOBILE COMMANDS
# =============================================================================

cmd_lightsail() {
    SUBCMD="${1:-help}"

    case "$SUBCMD" in
        setup)
            echo_step "Running Lightsail mobile setup..."
            if [ -f "$SCRIPT_DIR/lightsail/setup.sh" ]; then
                bash "$SCRIPT_DIR/lightsail/setup.sh"
            else
                echo_error "Lightsail setup script not found"
                echo_info "Expected at: $SCRIPT_DIR/lightsail/setup.sh"
                exit 1
            fi
            ;;
        session|s)
            # Quick session starter (wrapper for vibe command)
            PROJECT="${2:-default}"
            SESSION="vibe-$PROJECT"

            if tmux has-session -t "$SESSION" 2>/dev/null; then
                echo_info "Attaching to: $SESSION"
                tmux attach -t "$SESSION"
            else
                echo_step "Creating session: $SESSION"
                mkdir -p "$HOME/projects/$PROJECT"
                tmux new-session -d -s "$SESSION" -n "claude" -c "$HOME/projects/$PROJECT"
                tmux new-window -t "$SESSION" -n "shell" -c "$HOME/projects/$PROJECT"
                tmux select-window -t "$SESSION:1"
                tmux attach -t "$SESSION"
            fi
            ;;
        list|ls)
            echo "Active tmux sessions:"
            echo ""
            tmux list-sessions 2>/dev/null || echo_warning "No active sessions"
            ;;
        kill)
            if [ -z "$2" ]; then
                echo_error "Usage: vibecode lightsail kill <session>"
                tmux list-sessions 2>/dev/null
                exit 1
            fi
            tmux kill-session -t "$2" && echo_success "Killed: $2"
            ;;
        open-port|port)
            PORT="${2:-}"
            if [ -z "$PORT" ]; then
                echo_error "Usage: vibecode lightsail open-port <port>"
                exit 1
            fi

            # Check if AWS CLI is configured
            if ! command -v aws &>/dev/null; then
                echo_error "AWS CLI not installed"
                echo_info "Run: vibecode lightsail aws-setup"
                exit 1
            fi

            if ! aws sts get-caller-identity &>/dev/null; then
                echo_error "AWS CLI not configured"
                echo_info "Run: aws configure"
                exit 1
            fi

            # Get instance name
            INSTANCE_NAME="${LIGHTSAIL_INSTANCE:-}"
            if [ -z "$INSTANCE_NAME" ]; then
                echo_step "Detecting Lightsail instance..."
                INSTANCE_NAME=$(aws lightsail get-instances --query 'instances[0].name' --output text 2>/dev/null)
                if [ -z "$INSTANCE_NAME" ] || [ "$INSTANCE_NAME" = "None" ]; then
                    echo_error "Could not detect instance. Set LIGHTSAIL_INSTANCE env var"
                    exit 1
                fi
                echo_info "Found instance: $INSTANCE_NAME"
            fi

            echo_step "Opening port $PORT on $INSTANCE_NAME..."
            if aws lightsail open-instance-public-ports \
                --instance-name "$INSTANCE_NAME" \
                --port-info "fromPort=$PORT,toPort=$PORT,protocol=tcp" 2>/dev/null; then
                echo_success "Port $PORT opened"
            else
                echo_error "Failed to open port $PORT"
                exit 1
            fi
            ;;
        aws-setup)
            echo_step "Setting up AWS CLI for Lightsail..."
            echo ""

            # Check if AWS CLI is installed
            if ! command -v aws &>/dev/null; then
                echo_step "Installing AWS CLI..."
                curl -s "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
                unzip -q /tmp/awscliv2.zip -d /tmp
                sudo /tmp/aws/install || /tmp/aws/install --bin-dir ~/.local/bin --install-dir ~/.local/aws-cli
                rm -rf /tmp/aws /tmp/awscliv2.zip
                echo_success "AWS CLI installed"
            else
                echo_success "AWS CLI already installed"
            fi

            echo ""
            echo "Now configure your AWS credentials:"
            echo ""
            echo "  1. Go to AWS IAM Console"
            echo "  2. Create/use a user with AmazonLightsailFullAccess policy"
            echo "  3. Generate Access Key"
            echo "  4. Run: aws configure"
            echo ""
            echo "Optional: Set default instance name:"
            echo "  export LIGHTSAIL_INSTANCE=your-instance-name"
            echo ""
            ;;
        ports)
            # List open ports on instance
            if ! aws sts get-caller-identity &>/dev/null; then
                echo_error "AWS CLI not configured. Run: aws configure"
                exit 1
            fi

            INSTANCE_NAME="${LIGHTSAIL_INSTANCE:-}"
            if [ -z "$INSTANCE_NAME" ]; then
                INSTANCE_NAME=$(aws lightsail get-instances --query 'instances[0].name' --output text 2>/dev/null)
            fi

            echo "Open ports on $INSTANCE_NAME:"
            echo ""
            aws lightsail get-instance-port-states \
                --instance-name "$INSTANCE_NAME" \
                --query 'portStates[*].[fromPort,toPort,protocol,state]' \
                --output table 2>/dev/null || echo_error "Failed to list ports"
            ;;
        help|*)
            echo "Lightsail / Mobile Commands"
            echo ""
            echo "  ${GREEN}vibecode lightsail setup${NC}        Install mobile environment"
            echo "  ${GREEN}vibecode lightsail session${NC} [p]  Start/attach coding session"
            echo "  ${GREEN}vibecode lightsail list${NC}         List active sessions"
            echo "  ${GREEN}vibecode lightsail kill${NC} <name>  Kill a session"
            echo ""
            echo "  ${GREEN}vibecode lightsail aws-setup${NC}    Install/configure AWS CLI"
            echo "  ${GREEN}vibecode lightsail open-port${NC} N  Open port N on firewall"
            echo "  ${GREEN}vibecode lightsail ports${NC}        List open ports"
            echo ""
            echo "After setup, you can also use:"
            echo "  ${CYAN}vibe <project>${NC}    Quick session start"
            echo "  ${CYAN}vibe-list${NC}         List sessions"
            echo ""
            ;;
    esac
}

# =============================================================================
# COMMANDS
# =============================================================================

cmd_help() {
    show_banner
    echo "Usage: vibecode <command> [options]"
    echo ""
    echo "Commands:"
    echo "  ${GREEN}init${NC}                      Install ClaudeBox + dependencies"
    echo "  ${GREEN}new${NC} <project> [profile]   Create isolated project environment"
    echo "  ${GREEN}shell${NC} <project>           Enter project shell"
    echo "  ${GREEN}code${NC} <project>            Start Claude Code in project"
    echo "  ${GREEN}list${NC}                      List all projects"
    echo "  ${GREEN}status${NC} [project]          Show project status"
    echo "  ${GREEN}remove${NC} <project>          Delete project environment"
    echo "  ${GREEN}lightsail${NC} <subcommand>    Mobile/Lightsail setup & sessions"
    echo "  ${GREEN}dashboard${NC} [port]          Start web dashboard (default: 8080)"
    echo "  ${GREEN}help${NC}                      Show this help"
    echo ""
    echo "Lightsail/Mobile:"
    echo "  vibecode lightsail setup       Install mobile environment (tmux, etc)"
    echo "  vibecode lightsail session [p] Start/attach to coding session"
    echo "  vibecode lightsail list        List active tmux sessions"
    echo ""
    echo "Examples:"
    echo "  vibecode init"
    echo "  vibecode new my-api python"
    echo "  vibecode new my-frontend javascript"
    echo "  vibecode shell my-api"
    echo "  vibecode code my-api"
    echo "  vibecode list"
    echo "  vibecode status my-api"
    echo "  vibecode remove my-api"
    echo "  vibecode lightsail setup"
    echo "  vibecode dashboard 8080"
    echo ""
    echo "Profiles: python, javascript, go, rust, java, php, ruby, c, cpp"
    echo ""
}

cmd_init() {
    show_banner
    echo_step "Initializing Vibecoding Stack..."
    echo ""

    # Check if claudebox is installed
    if command -v claudebox &> /dev/null; then
        echo_success "ClaudeBox already installed"
    else
        echo_step "Installing ClaudeBox..."

        # Download installer
        INSTALLER="/tmp/claudebox.run"
        if [ ! -f "$INSTALLER" ]; then
            URL="https://github.com/RchGrav/claudebox/releases/latest/download/claudebox.run"

            if command -v curl &> /dev/null; then
                echo_info "Downloading ClaudeBox installer with curl..."
                curl -fsSL "$URL" -o "$INSTALLER"
            elif command -v wget &> /dev/null; then
                echo_info "Downloading ClaudeBox installer with wget..."
                wget -q --show-progress "$URL" -O "$INSTALLER"
            else
                echo_error "Neither curl nor wget found. Please install one of them."
                echo_info "Install with: brew install curl"
                exit 1
            fi
        fi

        chmod +x "$INSTALLER"
        "$INSTALLER"

        echo_success "ClaudeBox installed"
    fi

    # Check Python
    echo_step "Checking Python..."
    if command -v python3 &> /dev/null; then
        PYTHON_VERSION=$(python3 --version)
        echo_success "Python found: $PYTHON_VERSION"
    else
        echo_error "Python3 not found. Please install Python 3.10+"
        exit 1
    fi

    # Install Python dependencies
    echo_step "Installing Python dependencies..."
    pip3 install --user --quiet --break-system-packages \
        sqlalchemy \
        mcp \
        "aleph-rlm[mcp]" 2>/dev/null || \
        pip3 install --user --quiet --break-system-packages \
            "git+https://github.com/Hmbown/aleph.git#egg=aleph-rlm[mcp]"
    echo_success "Dependencies installed"

    # Make vibecode globally accessible
    echo_step "Setting up global command..."
    INSTALL_PATH="/usr/local/bin/vibecode"
    if [ -w "/usr/local/bin" ]; then
        ln -sf "$SCRIPT_DIR/vibecode" "$INSTALL_PATH"
        echo_success "vibecode command installed to $INSTALL_PATH"
    else
        echo_warning "Cannot write to /usr/local/bin"
        echo_info "Run: sudo ln -s $SCRIPT_DIR/vibecode /usr/local/bin/vibecode"
    fi

    echo ""
    echo_success "Initialization complete!"
    echo ""
    echo "Next steps:"
    echo "  vibecode new <project-name> [profile]"
    echo ""
}

cmd_new() {
    if [ -z "$1" ]; then
        echo_error "Usage: vibecode new <project-name> [profile]"
        exit 1
    fi

    PROJECT_NAME="$1"
    PROFILE="${2:-python}"

    show_banner
    echo "  Project: ${GREEN}$PROJECT_NAME${NC}"
    echo "  Profile: ${BLUE}$PROFILE${NC}"
    echo ""

    # Check if claudebox is installed
    if ! command -v claudebox &> /dev/null; then
        echo_error "ClaudeBox not installed!"
        echo_info "Run: vibecode init"
        exit 1
    fi

    # Ensure global skills directory exists on host
    GLOBAL_SKILLS_DIR="$HOME/.claude/skills/learned"
    mkdir -p "$GLOBAL_SKILLS_DIR"

    # Create claudebox container
    echo_step "Creating isolated container..."
    claudebox new "$PROJECT_NAME" --profile "$PROFILE"
    echo_success "Container created"

    # Mount global skills into container
    CONTAINER_PATH="$CLAUDEBOX_HOME/$PROJECT_NAME"
    if [ -d "$CONTAINER_PATH" ]; then
        ln -sf "$GLOBAL_SKILLS_DIR" "$CONTAINER_PATH/host-skills" 2>/dev/null || true
        echo_success "Global skills mounted"
    fi

    # Setup vibecoding stack inside
    CONTAINER_PATH="$CLAUDEBOX_HOME/$PROJECT_NAME"

    echo_step "Installing Vibecoding Stack..."

    # Create installation script
    cat > "$CONTAINER_PATH/.install-vibecoding.sh" << 'EOF'
#!/bin/bash
set -e
cd /workspace

# Clone autocoder
if [ ! -d "autocoder" ]; then
    git clone -q https://github.com/leonvanzyl/autocoder.git autocoder
fi

# Install planning skill
mkdir -p ~/.claude/skills
if [ ! -d ~/.claude/skills/planning-with-files ]; then
    git clone -q https://github.com/OthmanAdi/planning-with-files.git /tmp/planning
    cp -r /tmp/planning/planning-with-files ~/.claude/skills/
    rm -rf /tmp/planning
fi

# Setup global skills symlink (shared across all containers)
mkdir -p ~/.claude/skills/learned
if [ -d /host-skills ] && [ ! -L ~/.claude/skills/learned ]; then
    # Remove local learned dir and symlink to host
    rm -rf ~/.claude/skills/learned
    ln -s /host-skills ~/.claude/skills/learned
    echo "✓ Global skills linked"
fi

# Setup MCP server
mkdir -p autocoder/mcp_server

# Create vibecoding MCP server
cat > autocoder/mcp_server/vibecoding_server.py << 'EOFMCP'
#!/usr/bin/env python3
"""Vibecoding Stack MCP Server - Integrated"""
import sys
import json

def main():
    print(json.dumps({
        "tools": [
            {"name": "feature_get_next", "description": "Get next feature"},
            {"name": "feature_mark_passing", "description": "Mark feature complete"},
            {"name": "aleph_search", "description": "Search codebase"},
            {"name": "quality_check", "description": "Run quality gates"}
        ]
    }), file=sys.stderr)

if __name__ == "__main__":
    main()
EOFMCP

chmod +x autocoder/mcp_server/vibecoding_server.py

# Configure Claude Desktop
mkdir -p ~/.config/claude-desktop
cat > ~/.config/claude-desktop/claude_desktop_config.json << 'EOFCONFIG'
{
  "mcpServers": {
    "vibecoding": {
      "command": "python3",
      "args": ["/workspace/autocoder/mcp_server/vibecoding_server.py"]
    }
  }
}
EOFCONFIG

# Setup project .claude config
mkdir -p /workspace/.claude/commands

echo "✓ Vibecoding Stack installed"
EOF

    chmod +x "$CONTAINER_PATH/.install-vibecoding.sh"

    # Run installation
    claudebox exec "$PROJECT_NAME" /workspace/.install-vibecoding.sh

    # Copy settings
    if [ -f "$SCRIPT_DIR/.claude/settings.json" ]; then
        mkdir -p "$CONTAINER_PATH/workspace/.claude"
        cp "$SCRIPT_DIR/.claude/settings.json" "$CONTAINER_PATH/workspace/.claude/"
    fi

    echo_success "Vibecoding Stack installed"
    echo ""
    echo "╔══════════════════════════════════════════════════════════════╗"
    echo "║     PROJECT READY                                            ║"
    echo "╚══════════════════════════════════════════════════════════════╝"
    echo ""
    echo "  Start coding:"
    echo ""
    echo "    ${GREEN}vibecode shell $PROJECT_NAME${NC}"
    echo "    ${GREEN}vibecode code $PROJECT_NAME${NC}"
    echo ""
}

cmd_shell() {
    if [ -z "$1" ]; then
        echo_error "Usage: vibecode shell <project-name>"
        exit 1
    fi

    PROJECT_NAME="$1"

    if [ ! -d "$CLAUDEBOX_HOME/$PROJECT_NAME" ]; then
        echo_error "Project not found: $PROJECT_NAME"
        echo_info "Run: vibecode list"
        exit 1
    fi

    echo_info "Entering ${GREEN}$PROJECT_NAME${NC} environment..."
    claudebox shell "$PROJECT_NAME"
}

cmd_code() {
    if [ -z "$1" ]; then
        echo_error "Usage: vibecode code <project-name>"
        exit 1
    fi

    PROJECT_NAME="$1"

    if [ ! -d "$CLAUDEBOX_HOME/$PROJECT_NAME" ]; then
        echo_error "Project not found: $PROJECT_NAME"
        exit 1
    fi

    echo_info "Starting Claude Code in ${GREEN}$PROJECT_NAME${NC}..."
    claudebox exec "$PROJECT_NAME" "cd /workspace && claude"
}

cmd_list() {
    show_banner
    echo "Isolated Projects:"
    echo ""

    if [ ! -d "$CLAUDEBOX_HOME" ] || [ -z "$(ls -A "$CLAUDEBOX_HOME" 2>/dev/null)" ]; then
        echo_warning "No projects found"
        echo_info "Create one with: vibecode new <project-name>"
        echo ""
        return
    fi

    for project in "$CLAUDEBOX_HOME"/*; do
        if [ -d "$project" ]; then
            PROJECT_NAME=$(basename "$project")

            # Check if vibecoding is installed
            if [ -f "$project/workspace/autocoder/mcp_server/vibecoding_server.py" ]; then
                STATUS="${GREEN}✓ vibecoding${NC}"
            else
                STATUS="${YELLOW}⚠ no vibecoding${NC}"
            fi

            # Get size
            SIZE=$(du -sh "$project" 2>/dev/null | cut -f1)

            echo -e "  ${CYAN}$PROJECT_NAME${NC}"
            echo -e "    Status: $STATUS"
            echo -e "    Size:   $SIZE"
            echo -e "    Path:   $project"
            echo ""
        fi
    done
}

cmd_status() {
    PROJECT_NAME="$1"

    if [ -z "$PROJECT_NAME" ]; then
        cmd_list
        return
    fi

    if [ ! -d "$CLAUDEBOX_HOME/$PROJECT_NAME" ]; then
        echo_error "Project not found: $PROJECT_NAME"
        exit 1
    fi

    show_banner
    echo "Project: ${GREEN}$PROJECT_NAME${NC}"
    echo ""

    PROJECT_PATH="$CLAUDEBOX_HOME/$PROJECT_NAME"

    # Check components
    echo "Components:"

    if [ -d "$PROJECT_PATH/workspace/autocoder" ]; then
        echo -e "  ${GREEN}✓${NC} Autocoder"
    else
        echo -e "  ${RED}✗${NC} Autocoder"
    fi

    if [ -f "$PROJECT_PATH/workspace/autocoder/mcp_server/vibecoding_server.py" ]; then
        echo -e "  ${GREEN}✓${NC} MCP Server"
    else
        echo -e "  ${RED}✗${NC} MCP Server"
    fi

    if [ -d "$PROJECT_PATH/workspace/.claude" ]; then
        echo -e "  ${GREEN}✓${NC} Claude Config"
    else
        echo -e "  ${RED}✗${NC} Claude Config"
    fi

    echo ""
    echo "Storage:"
    SIZE=$(du -sh "$PROJECT_PATH" 2>/dev/null | cut -f1)
    echo "  Total: $SIZE"
    echo ""
    echo "Actions:"
    echo "  ${GREEN}vibecode shell $PROJECT_NAME${NC}   - Enter shell"
    echo "  ${GREEN}vibecode code $PROJECT_NAME${NC}    - Start Claude Code"
    echo ""
}

cmd_remove() {
    if [ -z "$1" ]; then
        echo_error "Usage: vibecode remove <project-name>"
        exit 1
    fi

    PROJECT_NAME="$1"

    if [ ! -d "$CLAUDEBOX_HOME/$PROJECT_NAME" ]; then
        echo_error "Project not found: $PROJECT_NAME"
        exit 1
    fi

    echo_warning "This will DELETE the project: $PROJECT_NAME"
    read -p "Are you sure? (yes/no): " CONFIRM

    if [ "$CONFIRM" != "yes" ]; then
        echo "Cancelled"
        exit 0
    fi

    claudebox remove "$PROJECT_NAME"
    echo_success "Project removed: $PROJECT_NAME"
}

# =============================================================================
# DASHBOARD COMMAND
# =============================================================================

cmd_dashboard() {
    PORT="${1:-8080}"

    echo_step "Starting Vibecode Dashboard on port $PORT..."
    echo ""

    if [ ! -f "$SCRIPT_DIR/dashboard/server.py" ]; then
        echo_error "Dashboard server not found"
        echo_info "Expected at: $SCRIPT_DIR/dashboard/server.py"
        exit 1
    fi

    # Ensure log directory exists
    mkdir -p "$HOME/.claude/logs"

    # Auto-open port on Lightsail if AWS CLI is configured
    if command -v aws &>/dev/null && aws sts get-caller-identity &>/dev/null 2>&1; then
        INSTANCE_NAME="${LIGHTSAIL_INSTANCE:-}"
        if [ -z "$INSTANCE_NAME" ]; then
            INSTANCE_NAME=$(aws lightsail get-instances --query 'instances[0].name' --output text 2>/dev/null)
        fi
        if [ -n "$INSTANCE_NAME" ] && [ "$INSTANCE_NAME" != "None" ]; then
            echo_step "Opening port $PORT on Lightsail firewall..."
            if aws lightsail open-instance-public-ports \
                --instance-name "$INSTANCE_NAME" \
                --port-info "fromPort=$PORT,toPort=$PORT,protocol=tcp" 2>/dev/null; then
                echo_success "Port $PORT opened on $INSTANCE_NAME"
            fi
        fi
    fi

    # Start server
    python3 "$SCRIPT_DIR/dashboard/server.py" "$PORT"
}

# =============================================================================
# MAIN
# =============================================================================

COMMAND="${1:-help}"

case "$COMMAND" in
    init)
        cmd_init
        ;;
    new)
        shift
        cmd_new "$@"
        ;;
    shell)
        shift
        cmd_shell "$@"
        ;;
    code)
        shift
        cmd_code "$@"
        ;;
    list|ls)
        cmd_list
        ;;
    status)
        shift
        cmd_status "$@"
        ;;
    remove|rm)
        shift
        cmd_remove "$@"
        ;;
    lightsail|ls-mobile|mobile)
        shift
        cmd_lightsail "$@"
        ;;
    dashboard|dash)
        shift
        cmd_dashboard "$@"
        ;;
    help|--help|-h)
        cmd_help
        ;;
    *)
        echo_error "Unknown command: $COMMAND"
        echo_info "Run: vibecode help"
        exit 1
        ;;
esac
